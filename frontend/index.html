<!DOCTYPE html>
<html lang="en">
<head>
    </head>
<body>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- All your DOM Elements are the same ---
        const configSection = document.getElementById('config-section');
        const appSection = document.getElementById('app-section');
        // ... etc ...

        let allItems = [];
        let settings = {};
        let pollInterval = null; // --- NEW: Variable to hold our timer ---

        // --- All utility functions are the same ---
        const loadSettings = () => { /* ... */ };
        const saveSettings = (apiUrl, apiKey) => { /* ... */ };
        
        const showConfigView = () => {
            configSection.style.display = 'block';
            appSection.style.display = 'none';
            if (pollInterval) clearInterval(pollInterval); // --- NEW: Stop polling when going to config ---
        };

        const showAppView = async () => {
            configSection.style.display = 'none';
            appSection.style.display = 'block';
            await fetchAndRenderList(true); // Initial fetch shows loading spinner

            // --- NEW: Start polling every 5 seconds ---
            if (pollInterval) clearInterval(pollInterval); // Clear any old timer
            pollInterval = setInterval(() => {
                fetchAndRenderList(false); // Background fetches don't show loading spinner
            }, 5000); // 5000 milliseconds = 5 seconds
        };

        // --- UPDATED: fetchAndRenderList now accepts a parameter ---
        const fetchAndRenderList = async (showLoading = false) => {
            if (!settings.apiUrl || !settings.apiKey) return;
            if (showLoading) {
                loadingDiv.style.display = 'block';
                shoppingListUl.innerHTML = '';
            }
            
            try {
                const response = await fetch(settings.apiUrl, {
                    method: 'GET',
                    headers: { 'x-api-key': settings.apiKey }
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                
                const newItems = await response.json();
                
                // Only re-render if the data has actually changed
                if (JSON.stringify(newItems) !== JSON.stringify(allItems)) {
                    allItems = newItems;
                    renderList();
                    populateStoreFilter();
                }

            } catch (error) {
                console.error("Failed to fetch list:", error);
                // Don't alert on background refresh failures
                if (showLoading) alert("Could not fetch the shopping list.");
            } finally {
                if (showLoading) loadingDiv.style.display = 'none';
            }
        };

        // --- The rest of your JavaScript is exactly the same ---
        const renderList = () => { /* ... */ };
        const populateStoreFilter = () => { /* ... */ };
        const toggleItemStatus = async (itemElement) => { /* ... */ };
        // ... all event listeners ...

        loadSettings();
    });
</script>

</body>
</html>
